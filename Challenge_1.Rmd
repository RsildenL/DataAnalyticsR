---
title: "Challenge 1: General Overview and Data Treatment"
subtitle: "Data Analytics with R"
author: "Rebecca Silden Langlo, Afonso Penalva, Kevin Ganglbauer, Henrik Mülheims, Martí Pérez & others abc" 
date: "2/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
```



```{r}
machine_data <- fread("Data/machine_data.csv")
product_data <- fread("Data/product_data.csv")
 # we all need to include the transactional_data file in the Data folder, but we can't push it to the git repository
transaction_data <- fread("Data/transactional_data.csv")
```


```{r}
transaction_product <- merge(transaction_data, product_data, by.x = "product_name", by.y ="product_name")
merged_data <- merge(transaction_product, machine_data, by= "machine")
```


## Question 1: General overview of the data
### Machines
```{r}
number_of_machines <- uniqueN(machine_data$machine)
number_of_machines
```

```{r}
machine_dist <- machine_data[,.(.N), by=small_machine]
machine_dist[,percent := N/number_of_machines]
machine_dist$type <- ifelse(machine_dist$small_machine == 1, 
                            yes = "small", no = "large")
machine_dist
```

```{r}
machine_dist_by_location <- machine_data[,.(.N),by = .(small_machine, location_type)]
machine_dist_by_location [,percent := N/number_of_machines]
machine_dist_by_location$type <- ifelse(machine_dist_by_location$small_machine == 1,
                            yes = "small", no = "large")
machine_dist_by_location
```

### Products 
```{r}
product_names <- unique(product_data$product_name)
number_of_products <- uniqueN(product_data$product_name)
product_dist <- product_data[,.(.N, mean_price = mean(price)), by=category]

number_of_products; product_dist
```


### Transactional data
```{r}
library("openair")
transaction_data$date <- as.Date(transaction_data$date)
transactions_march <- selectByDate(transaction_data, year = 2017, month = 3)
```


```{r}
### WHY DOES WE loose one row???
transactions_march_dist <- transactions_march[, .(.N), by=.(machine, date)]

uniqueN(transactions_march_dist$machine)
uniqueN(transactions_march_dist$date)

sales_dist <- transactions_march_dist[,.(mean_sales = mean(N)), by=machine]
sales_dist <- merge(sales_dist, machine_data[,.(machine, small_machine)], by.x = "machine", by.y= "machine")
sales_dist

sales_dist2 <- sales_dist[,.(avg_sales = mean(mean_sales)), by = small_machine]
sales_dist2
plot(sales_dist)
```


## Question 2: Plot interpretation 
![Caption](Q2.JPG)

a. Is there a general trend in the number of snacks and drinks as the months progress from January to April? Is it the same for snacks and drinks? Why do you think that
might be so?

* weekly seasonality (spikes on weekends?)
* drinks: an linear increasing trend (ANOVA?)
* snack: flat/no trend


```{r}

```


b. Is there shorter time period trend as well? Is it the same for snacks and drinks? What do you think might be the cause?


### Question 3: Distribution of income 



### Question 4: Boxplot interpretation 
![Boxplot](Q4.JPG)
```{r}
boxplot(machine_data$num_hotels)
summary(machine_data$num_hotels)
```

According to this boxplot the median number of hotels in the machine area is 0. This means that half or more of the observations is zero, this more than half of the vending machines does not have an hotel in the nearby area. The median is also in this case the same as the minimum and 1st quantile. 
The 3rd quantile is one, while the mean of the observations is 2. This is due to that most of the vending machines not have hotels nearby, while about half (4th quantile) of those who have hotels nearby seems to have many hotels, with the maximum of 79 hotels nearby.
--> if we want to use this feature later on - we should consider making a dummy of hotels nearby and not, then work on those with hotels nearby.

### Question 5: Location score
In this exercise we will build a location score that tells us what’s the average daily items per machine depending on the location it is placed. This model could be used to 
a) Decide in which locations to place new machines 
b) Construct a benchmark for each machine: how much should it sell according to its location? This can be used to detect problems in machines (i.e. illumination, bad placement within a station etc.)

```{r}
# create one data frame with all features

machine_data[,petrol_station:=ifelse(is.na(train_AvgDailyPassengers),1,0)]


```


#### Significant variables
Do all variables show statistical significance? Which ones doesn’t? How do you know?
Hint: Recall that to check the parameters of a glm model called “model1” you need to run summary(model1)

```{r}
#glm( ~ small_machine + income_average + total_number_of_routes_600
#     + num_hotels_45 + num_vendex_nearby_300, 
 #    data = machine_data)
```


#### Linear model 
Build another linear model but this time instead of using the variables
“total_number_of_routes_600 use the log of that variable in base 10 calling it
“log_transport”. Does this new variable show statistical significance?
```{r}

```


#### How many daily items less do small machines sell all other factors remaining equal?
```{r}

```

#### What’s effect on machine sales does having other nearby machines all other factors remaining equal?
```{r}

```

#### Top and bottom ratio
Ranking all machines according to the final_model, what are the real daily sales of the top20% machines with respect to your model prediction? And the real daily sales of the bottom20% machines according to your model? What’s the
top20%/bottom20% ratio?



#### Choice
Given the following 2 locations for a big machine:
i. Supermarket entrance, 2 nearby hotels of 4 stars, 20 transport routes, no
nearby machines
ii. Transport station, no nearby hotels of 4 or 5 stars, 10 transport routes
nearby, 3 nearby Vendex machines
Which location would you choose and why?

